# Makefile pour k8s-mono Ubuntu 24.04 + Kubernetes 1.32.4

IMAGE_NAME ?= k8s-mono
TAG ?= 1.32-ubuntu24
REGISTRY ?= your-registry.com
FULL_IMAGE = $(IMAGE_NAME):$(TAG)
REGISTRY_IMAGE = $(REGISTRY)/$(FULL_IMAGE)

.PHONY: help build test push clean shell logs check-files

help:
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  Makefile k8s-mono Ubuntu 24.04 + Kubernetes 1.32"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Commandes disponibles:"
	@echo "  make build         - Builder l'image k8s 1.32"
	@echo "  make test          - Tester l'image (automatique)"
	@echo "  make test-manual   - Lancer un conteneur pour test manuel"
	@echo "  make push          - Pousser vers le registry"
	@echo "  make shell         - Ouvrir un shell dans l'image"
	@echo "  make logs          - Voir les logs du conteneur de test"
	@echo "  make clean         - Nettoyer les conteneurs de test"
	@echo "  make check-files   - VÃ©rifier la prÃ©sence des fichiers requis"
	@echo "  make all           - Build + Test + Push"
	@echo ""
	@echo "Variables:"
	@echo "  IMAGE_NAME=$(IMAGE_NAME)"
	@echo "  TAG=$(TAG)"
	@echo "  REGISTRY=$(REGISTRY)"
	@echo ""

check-files:
	@echo "ğŸ” VÃ©rification des fichiers requis..."
	@test -f Dockerfile || (echo "âŒ Dockerfile manquant" && exit 1)
	@test -f deploy-k8s.sh || (echo "âŒ deploy-k8s.sh manquant" && exit 1)
	@test -f kubelet.service || (echo "âŒ kubelet.service manquant" && exit 1)
	@test -f kubelet.env || (echo "âŒ kubelet.env manquant" && exit 1)
	@test -f wrapkubeadm.sh || (echo "âŒ wrapkubeadm.sh manquant" && exit 1)
	@test -f systemctl || (echo "âŒ systemctl manquant" && exit 1)
	@test -f tokens.csv || (echo "âŒ tokens.csv manquant" && exit 1)
	@test -f daemon.json || (echo "âŒ daemon.json manquant" && exit 1)
	@test -f resolv.conf.override || (echo "âŒ resolv.conf.override manquant" && exit 1)
	@test -f motd || (echo "âŒ motd manquant" && exit 1)
	@echo "âœ… Tous les fichiers requis sont prÃ©sents"

build: check-files
	@echo "ğŸ”¨ Building image $(FULL_IMAGE)..."
	docker build -t $(FULL_IMAGE) .
	@echo "âœ… Image built: $(FULL_IMAGE)"
	@docker images $(IMAGE_NAME)

test: build
	@echo "ğŸ§ª Testing image $(FULL_IMAGE)..."
	@chmod +x test-k8s-image.sh
	./test-k8s-image.sh $(FULL_IMAGE)

test-manual: build
	@echo "ğŸš€ Lancement d'un conteneur de test manuel..."
	@docker run --rm --privileged --name k8s-test-manual -d $(FULL_IMAGE) || true
	@echo ""
	@echo "âœ… Conteneur lancÃ©: k8s-test-manual"
	@echo ""
	@echo "Commandes utiles:"
	@echo "  docker logs -f k8s-test-manual          # Voir les logs"
	@echo "  docker exec -it k8s-test-manual bash    # Se connecter"
	@echo "  docker exec k8s-test-manual kubectl get nodes"
	@echo "  docker exec k8s-test-manual kubectl get pods -A"
	@echo ""
	@echo "Pour arrÃªter: docker stop k8s-test-manual"

push: build
	@echo "ğŸ“¤ Pushing image to registry..."
	docker tag $(FULL_IMAGE) $(REGISTRY_IMAGE)
	docker tag $(FULL_IMAGE) $(REGISTRY)/$(IMAGE_NAME):latest
	docker push $(REGISTRY_IMAGE)
	docker push $(REGISTRY)/$(IMAGE_NAME):latest
	@echo "âœ… Image pushed to registry"

shell: build
	@echo "ğŸš Opening shell in $(FULL_IMAGE)..."
	docker run --rm -it --privileged $(FULL_IMAGE) /bin/bash

logs:
	@echo "ğŸ“‹ Logs du conteneur de test..."
	@docker logs k8s-test-manual 2>/dev/null || echo "âŒ Aucun conteneur k8s-test-manual en cours"

clean:
	@echo "ğŸ§¹ Cleaning up test containers..."
	@docker stop k8s-test-manual 2>/dev/null || true
	@docker rm -f k8s-test-manual 2>/dev/null || true
	@docker ps -a | grep "k8s-test-" | awk '{print $$1}' | xargs -r docker rm -f 2>/dev/null || true
	@echo "âœ… Cleanup complete"

all: build test push
	@echo ""
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo "  âœ… Build, Test, and Push completed successfully!"
	@echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

.DEFAULT_GOAL := help
